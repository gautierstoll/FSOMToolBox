buildFSOMTreev2 <- function(tableTreatmentName,dirFCS,gatingName,fcsPattern,compensate, prettyNames,clustDim,metaClNb,fSOMSeed){
   
  tableTreatmentFCS<-read.csv(tableTreatmentName,header = TRUE,sep = ";")
  flowJoWS=list.files(pattern=".wsp")
  if (length(flowJoWS) > 1)
  {
    stop("several FlowJoWorkSpace")
  }
  if (dirFCS == "") {absoluteDirFCS = getwd() }
  else {
    absoluteDirFCS=paste(getwd(),"/",dirFCS,"/",sep="")
  }
  files<-list.files(path = absoluteDirFCS , pattern=fcsPattern)
  if ((unlist(packageVersion("CytoML"))[1] == 1) & (unlist(packageVersion("CytoML"))[2] >= 12)) {
    ## print("Parse flowJo within version 1.12 of CytoML")
    data<-parse_flowjo_CytoML_v12(files,flowJoWS)}
  else {
    data<-parse_flowjo_CytoML(files,flowJoWS)
  }
  dataGated<-gating_subset_toolBox(data,gatingName)
  fSOM<-FlowSOM::ReadInput(dataGated$flowSet,compensate = compensate,transform = FALSE,scale = FALSE,scaled.center = TRUE,scaled.scale = TRUE,silent = FALSE)
  Cytodata<-list(fSOMData=fSOM,flJoDataGated=dataGated)
  
  set.seed(fSOMSeed)
  if (length(which(names(Cytodata) == "fSOMData")) > 0 )
  {fSOMData = Cytodata$fSOMData} else {fSOMData = Cytodata}
  ## ff<-fSOMDloaded$flJoDataGated$flowSet[[1]]
  fSOMNicePrettyColNames=gsub(" <.*", "", fSOMData$prettyColnames)
  colNamesIndices=unlist(lapply(prettyNames,function(name){which(fSOMNicePrettyColNames == name)}))
  print("Catched col indices:")
  print(colNamesIndices)
  ##channels_of_interest <-  fSOMData$prettyColnames[colNamesIndices]
  fSOM<-FlowSOM::BuildSOM(fSOMData,colsToUse = colNamesIndices,silent = FALSE,xdim=clustDim,ydim=clustDim,rlen=10,init=FALSE,distf=2)
  fSOM<-FlowSOM::BuildMST(fSOM,silent = FALSE,tSNE=FALSE)
  fSOM$prettyColnames =  fSOMNicePrettyColNames
  metacl<-FlowSOM::metaClustering_consensus(fSOM$map$codes,k=metaClNb,seed=fSOMSeed)
  PlotStarsBigLeg(fSOM,backgroundValues = as.factor(metacl))
  return(list(fSOMTree = fSOM,metaCl = metacl))
  }
