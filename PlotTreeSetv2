plotTreeSetv2 <- function(TreeMetacl,markers,Title,rmClNb,treatmentTable,globalScale=T){
  if (rmClNb>0) {
    indexKeep =  which(TreeMetacl$fSOMTree$MST$size > sort(TreeMetacl$fSOMTree$MST$size)[rmClNb])} else {indexKeep = 1:length(TreeMetacl$fSOMTree$MST$size)}
  pdf(file=paste(Title,"_TreatmentTree.pdf",sep=""))
  ## plot tree of pooled data
  PlotStarsMSTRmv2(TreeMetacl,Title,rmClNb)
  PlotLabelsRmv2(TreeMetacl$fSOMTree,TreeMetacl$metaCl,paste(Title,"_MetaclusterTree",sep=""),rmClNb)
  
  Treatments=unique(treatmentTable$Treatment[which(sapply(tableTreatmentFCS$files,function(files){length(grep(files,names(TreeMetacl$fSOMTree$metaData),fixed=T))>0}))])
  print("Treatments:")
  print(Treatments)
  
  ## plot tree of subdata for each treatments
  for (treatName in Treatments) {
    fcsFiles=treatmentTable$files[which(treatmentTable$Treatment == treatName)]
    treatIndex = unlist(sapply(fcsFiles,function(file){grep(file,names(TreeMetacl$fSOMTree$metaData),fixed=T)}))
    print(paste("Plot tree for treatment",treatName))
    PlotStarsMSTCondRm(TreeMetacl$fSOMTree,TreeMetacl$metaCl,treatIndex,paste(Title," Treat: ",treatName,sep=""),rmClNb)
  }
  dev.off()
  pdf(file=paste(Title,"_MarkerTree.pdf",sep=""))
  markersInData = intersect(markers,TreeMetacl$fSOMTree$prettyColnames)
  print("Markers:")
  print(markersInData)
  ##plot tree for each marker
  for (marker in markersInData)
  {
    uglyName = names(which(TreeMetacl$fSOMTree$prettyColnames == marker))
    if (globalScale) ## construct the global scale for color scale of markers
    {
      listTreatmentIndices = lapply(unique(treatmentTable$Treatment),function(treatName){
        fcsFiles=treatmentTable$files[which(treatmentTable$Treatment == treatName)]
        CondIndex = unlist(sapply(fcsFiles,function(file){grep(file,names(TreeMetacl$fSOMTree$metaData),fixed=T)}))
        return(unlist(sapply(TreeMetacl$fSOMTree$metaData[CondIndex],function(x){x[1]:x[2]})))
      })
      maxMin = matrix(unlist(lapply((1:length(TreeMetacl$fSOMTree$map$medianValues[,1]))[indexKeep],function(cluster){
        medianList=sapply(listTreatmentIndices,function(indices){
          median(TreeMetacl$fSOMTree$data[intersect(indices,which(TreeMetacl$fSOMTree$map$mapping[,1] == cluster)),uglyName])});
        c(max(medianList,na.rm=T),min(medianList,na.rm=T))
      })),nrow=2)
      maxGlobal = max(maxMin[1,])
      minGlobal = min(maxMin[2,])
      print(paste("Scale for marker",marker,":",minGlobal,"->",maxGlobal))
      globMinMax=c(minGlobal,maxGlobal)
    }
    else {globMinMax=c()}
    ##print(paste("Marker: ",marker,sep=""))
    print(paste("Plot tree for marker",marker," -- ",uglyName))
    PlotMarkerMSTRm(TreeMetacl$fSOMTree,uglyName,paste(Title," Marker: ",marker,sep=""),rmClNb,globMinMax)
  }
  for (marker in markersInData){ ## plot tree for each marher and each treatment
    uglyName = names(which(TreeMetacl$fSOMTree$prettyColnames == marker))
    if (globalScale) ## construct the global scale for color scale of markers
    {
      listTreatmentIndices = lapply(unique(treatmentTable$Treatment),function(treatName){
        fcsFiles=treatmentTable$files[which(treatmentTable$Treatment == treatName)]
        CondIndex = unlist(sapply(fcsFiles,function(file){grep(file,names(TreeMetacl$fSOMTree$metaData),fixed=T)}))
        return(unlist(sapply(TreeMetacl$fSOMTree$metaData[CondIndex],function(x){x[1]:x[2]})))
      })
      maxMin = matrix(unlist(lapply((1:length(TreeMetacl$fSOMTree$map$medianValues[,1]))[indexKeep],function(cluster){medianList=sapply(listTreatmentIndices,function(indices){median(TreeMetacl$fSOMTree$data[intersect(indices,which(TreeMetacl$fSOMTree$map$mapping[,1] == cluster)),uglyName])});c(max(medianList,na.rm=T),min(medianList,na.rm=T))})),nrow=2)
      maxGlobal = max(maxMin[1,])
      minGlobal = min(maxMin[2,])
      globMinMax=c(minGlobal,maxGlobal)
    }
    else {globMinMax=c()}
    ##print(paste("Marker: ",marker,sep=""))
    for (treatName in Treatments){
      ##print(paste("Treatment: ",treatName,sep=""))
      fcsFiles=treatmentTable$files[which(treatmentTable$Treatment == treatName)]
      treatIndex = unlist(sapply(fcsFiles,function(file){grep(file,names(TreeMetacl$fSOMTree$metaData),fixed=T)}))
      print(paste("Plot tree for marker",marker," -- ",uglyName,"and treatment",treatName))
      PlotMarkerMSTCondRm(TreeMetacl$fSOMTree,uglyName,treatIndex,paste(Title," Marker: ",marker," Treat: ",treatName,sep=""),rmClNb,globMinMax)
    }
  }
  dev.off()
}
